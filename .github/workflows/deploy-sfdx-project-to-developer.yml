on:
  workflow_call:
    inputs:
      sonar-url:
        type: string
        description: URL of the Sonar server to use for analyzing the code. If omitted, the WTax Sonar server at sonar.wtax.co will be used. The `sonar-login` secret should hold a valid access token or username:password combination for this server.
        required: false
        default: https://sonar.wtax.co
      sonar-quality-gate:
        type: boolean
        description: Whether to poll the SonarQube instance until the quality gate status is available and fail the build if the quality gate fails.
        required: false
        default: false
      instance-url:
        type: string
        description: Salesforce instance URL to log in to as Dev Hub org
        required: false
        default: https://test.salesforce.com
      client-id:
        type: string
        description: OAuth client ID (sometimes called consumer key) of the connected app on Salesforce used to connect to the Dev Hub org
        required: false
        default: 3MVG9mVMtbWMH6luwQZnh1Uwup6n5H3x2AJnTMrd3_HZSuTHQaZCRI4NhVfJtunn5UMRvyVpscVI9br8CDFmY
      jwt-key-encrypted:
        type: string
        description: Ansible Vault-encrypted private key to connect to the target org with using the JWT flow (this should be encrypted using ansible-vault encrypt, NOT ansible-vault encrypt_string!)
        required: false
        default: |
            $ANSIBLE_VAULT;1.1;AES256
            32626165343364393933633561306133326136363461353836306431383230356138393032346537
            6139323937643763663131313036643965303366323437640a353265633231663761366531613738
            62653862636430323735373030326332313530613530383534386231316232353265306237636533
            3363386461363263300a646534363532643630613432333763393333393064343936393461376663
            66626130613338346536323931363263316132343638656662346536373739313263663561376137
            37653765616433623533373961353531306335303263373162313131343532303537623265356163
            63613561666461363265653532623561393233353831646534313161613566363134643930333732
            62336463323035633434373430336338303332363333616535346332626436626630393431363565
            33323635623465343664343565373065646363333964626662633530313563323336613063623566
            35643236316531363533663665373931353362343036343638616131333732633833333238626535
            34343235373433616131666565336537336638666237356662663961313962366436333431396461
            36343239306432386261663933396230663861363932333939386662643133663737623039626366
            33306566353639376130316630383561313134643365326433376564386638346138336135376564
            38363634386238393939333764343830363331646533303032346162316437346533383930373937
            38376331626361643466333837313264336339383864356661633538386537393464313762356564
            37383865333665313631643537376630616135643530343734323936303464313963626461333130
            30356464623765356163356333366166663931633431383837663465393066333335613934306130
            37353534333464653431666631386630626135383339326365626465323539396664333261333332
            37353462366165366432326561313361393036636238346465313136336465343062633536303964
            32653331393833386439383436613337663231306633633331653135343934626564376666333433
            62346163363437386631663364396161623237313065336161653061323761643030306338646236
            31646164333033326132623666313164663137333134343066306530653464343230346264316338
            37316335643762383038636438333563626239323062323365653161323131396361316633393931
            32663862356333313263383932326333313861633865306265383139633066626430663263323230
            32396666336163626261643139313533373830616462376438333632336139613463343962326334
            34356430316333633733383438643161366263633234366431396339613138303962326335643434
            33613633363964653734636135396439346130363131363163613033366566376537326564613036
            37343739323561323336393039343830613733393665646635356361343737633436323862633833
            31393730346536356632336638646132383963313032396130366663633061316434373564643038
            63363066313636303133613531313831353739363338316638623438636332663930393662383434
            36623738363436616237323864663033656534663265313136663833626338663730666164613963
            64326134373133666636326164363635316266383136376131646330393364366563636363303964
            31343462356135646236336431356139323637633262396362313833613832616136363066663739
            33366630346135353634323563363639303464383034396432623332363039393435393462306533
            36353463373566353331303934653239613631623465656236623139656635386438353735363537
            37663562356630313162313432613735656332323530356436343637383631383633353133646631
            31363132333061373335333538646466653232633336353237623661303038383334333833306266
            39333862633461393438343465323737613138646232336435636539343134666432653837663637
            63306234633432373534343463653465656365363161663730353831316432613532303334366136
            38653633363339613139613361333535323764633333653532643364383339646331623439623435
            63303637376164646266313338393238373132663562343762626333633937323161356163616138
            63363633323034653639343538373133666364646166366436343365636237303666376232396134
            37393562356236383363663666613661623762633039626338323765633730346438643231663465
            62636266336130643937393033366533353064323239653066373962323333643263646236333438
            65303938663538353133636139613330613133383339393665386236313761653236346234343036
            65383266633033623565643037333633656366663537336165373737623465356331643537626335
            63646439313835313432386163613564363230623634353765346535623630366164636639306365
            66333337356565396362613164396265396339336632636462393062636161383665663266356363
            37383238373438396462316636316134623165656633353138313035663931393232343162363036
            35626137353830666435313865626265393134666539393865653434343339636132636634396233
            34313736636137313062353337376234616438616338646438623630383337356330636363376462
            34373537396432303966306436376330653538343361346639656437306361623661313939373531
            64663865323436376436623064356534376432313539323935333663646230626365373736303866
            35633233366265663036616434336461616239366531616333623230616237396664333733636235
            62353135326561333333343433616435656134343461396362313534373332643431326538656539
            35376232613361333765373339303462316464343765356130633339396236353566333634313035
            36643065326264363861383933373930646432316566383036656636616438316137393161653138
            35616530666331316438333633323764373936663663666461613239383930313631643130663038
            36616562393266623837303639626437336662363963353366653439393934646435393439653939
            65613932336363623933393662343031633838383065653162336530306237363231663030303363
            65306239653733366362396663326534376435383662393866613936636338363637383863303331
            38326666313935636464356136663965343134623562333730326665633863643263326235366438
            62333538353335653561653139623430626237653731306565323232343030336566636635343235
            39316565663737353861393032333936343434633139623234666161646164616639303434616533
            30626334613230613966303066663161623833336162376436303931383931653163666632363736
            32346333646134343061353535303366336536613161623839626533633661316333313730643831
            35353935313963613833383861326263653936323736383433613736323435303536363738663962
            62623130623063633164336434313863356238333831343538376565326331366338373635303233
            36303838343761376561353631353234626139653161633039323739613939323162383536333238
            64643061633630306362363730626364373962353936666334326662663062396366356665653530
            38643062366537633039643662306665366130626466363038646532616133346134386137383331
            35356466383964306264313239653334623330386131363738383661383866313239353535366139
            35393132383338343938383430643334633030323334643630363130323636633333633364613139
            39393663333539323930663037373735316364396438343230663061306161616633336135646565
            38363337383461383139623234313466646239666661613035326166353631653833313966643035
            30356365323332333731316139333363313234326632353865653762396533626436353864383236
            37353834393832656665323361356665313765303565643961323161663466656537623062396632
            39326534393236366234623537623434663835636232303865386262353437363863303631666432
            65313139393938653235356161313961366339643664363531653639303462303362383462323934
            65663238333139653338383431386530646461326664633365363461343732613663303430323336
            34613165306633383735303839323465326135653733333431356435326363356638663231623763
            35316361636631393430376464653534616134306262636265643238633237633638396461666263
            64343961303931656263346335383235336162643138313537616132646537383761396233616132
            31373437663334666533626663303561353163613131396464663835333464653132656532333964
            37333231623133633564303261323761353865646233323336613231363339636430386535613235
            37303934653939333162666164306431616161323139623033343762643839313838383132623536
            62313165326266313235646234386161393064666233643061663831303930646362643438343262
            31623964316639326534
      username:
        type: string
        description: Username of Salesforce user to authenticate as; must have permission to create scratch orgs
        required: false
        default: admin@wtax.prod.developer
      run-tests:
        type: boolean
        description: Whether to run tests as part of the deployment. This is required when deploying to a production org.
        required: true
    secrets:
      ansible-vault-password:
        description: Password to be used to decrypt the `jwt-key-encrypted`.
        required: true
jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: print out inputs (for debugging purposes)
        run: |
          echo 'inputs.instance-url = ${{ inputs.instance-url }}' 
          echo 'inputs.client-id = ${{ inputs.client-id }}' 
          echo 'inputs.jwt-key-encrypted = ${{ inputs.jwt-key-encrypted }}' 
          echo 'inputs.username = ${{ inputs.username }}' 
          echo 'inputs.run-tests = ${{ inputs.run-tests }}'
  deploy:
    uses: wtaxco/wtax-github-actions-workflows/.github/workflows/deploy-sfdx-project.yml@main
    with:
      sonar-url: ${{ inputs.sonar-url }}
      sonar-quality-gate: ${{ inputs.sonar-quality-gate }}
      instance-url: ${{ inputs.instance-url }}
      client-id: ${{ inputs.client-id }}
      username: ${{ inputs.username }}
      jwt-key-encrypted: ${{ inputs.jwt-key-encrypted }}
      run-tests: ${{ inputs.run-tests }}
    secrets:
      ansible-vault-password: ${{ secrets.ansible-vault-password }}
